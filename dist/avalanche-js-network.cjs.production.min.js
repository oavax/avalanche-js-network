"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t,r,n=e(require("mitt")),i=require("avalanche-js-utils"),o=e(require("cross-fetch")),s=e(require("regenerator-runtime")),a=require("websocket");function c(e,t,r,n,i,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function u(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function s(e){c(o,n,i,s,a,"next",e)}function a(e){c(o,n,i,s,a,"throw",e)}s(void 0)}))}}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function p(e,t,r){return t&&h(e.prototype,t),r&&h(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function d(){return(d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function l(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,(Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function v(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return f(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?f(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(t=exports.MiddlewareType||(exports.MiddlewareType={}))[t.REQ=0]="REQ",t[t.RES=1]="RES",(r=exports.SubscribeReturns||(exports.SubscribeReturns={})).all="all",r.id="id",r.method="method";var m,b,y,R=function(){function e(e,t,r){var n=this;void 0===t&&(t=new Map),void 0===r&&(r=new Map),this.middlewares={request:{use:function(e,t){void 0===t&&(t="*"),n.pushMiddleware(e,exports.MiddlewareType.REQ,t)}},response:{use:function(e,t){void 0===t&&(t="*"),n.pushMiddleware(e,exports.MiddlewareType.RES,t)}}},this.reqMiddleware=(new Map).set("*",[]),this.resMiddleware=(new Map).set("*",[]),this.reqMiddleware=t,this.resMiddleware=r,this.url=e}var t=e.prototype;return t.pushMiddleware=function(e,t,r){if(t!==exports.MiddlewareType.REQ&&t!==exports.MiddlewareType.RES)throw new Error("Please specify the type of middleware being added");if(t===exports.MiddlewareType.REQ){var n=this.reqMiddleware.get(r)||[];this.reqMiddleware.set(r,[].concat(n,[e]))}else{var i=this.resMiddleware.get(r)||[];this.resMiddleware.set(r,[].concat(i,[e]))}},t.getMiddleware=function(e){for(var t,r=[],n=[],i=v(this.reqMiddleware.entries());!(t=i()).done;){var o=t.value,s=o[0],a=o[1];"string"==typeof s&&"*"!==s&&s===e&&r.push.apply(r,a),s instanceof RegExp&&s.test(e)&&r.push.apply(r,a),"*"===s&&r.push.apply(r,a)}for(var c,u=v(this.resMiddleware.entries());!(c=u()).done;){var h=c.value,p=h[0],d=h[1];"string"==typeof p&&"*"!==p&&p===e&&n.push.apply(n,d),p instanceof RegExp&&p.test(e)&&n.push.apply(n,d),"*"===p&&n.push.apply(n,d)}return[r,n]},e}();(m=exports.SocketConnection||(exports.SocketConnection={})).READY="ready",m.CONNECT="connect",m.ERROR="error",m.CLOSE="close",(b=exports.SocketState||(exports.SocketState={})).SOCKET_MESSAGE="socket_message",b.SOCKET_READY="socket_ready",b.SOCKET_CLOSE="socket_close",b.SOCKET_ERROR="socket_error",b.SOCKET_CONNECT="socket_connect",b.SOCKET_NETWORK_CHANGED="socket_networkChanged",b.SOCKET_ACCOUNTS_CHANGED="socket_accountsChanged",(y=exports.EmittType||(exports.EmittType={})).INSTANCE="instance",y.PUBSUB="pubsub";var w=function(e){function t(t){var r;if((r=e.call(this,t)||this).handlers={},!i.isWs(t))throw new Error(t+" is not websocket");return r.url=t,r.emitter=n(r.handlers),r}l(t,e);var r=t.prototype;return r.resetHandlers=function(){for(var e in this.handlers)delete this.handlers[e]},r.once=function(e,t){this.emitter.on(e,t),this.removeEventListener(e)},r.addEventListener=function(e,t){this.emitter.on(e,t)},r.removeEventListener=function(e,t){if(e)return t?this.emitter.off(e,t):void delete this.handlers[e];this.handlers={}},r.reset=function(){this.removeEventListener("*")},r.removeAllSocketListeners=function(){this.removeEventListener(exports.SocketState.SOCKET_MESSAGE),this.removeEventListener(exports.SocketState.SOCKET_READY),this.removeEventListener(exports.SocketState.SOCKET_CLOSE),this.removeEventListener(exports.SocketState.SOCKET_ERROR),this.removeEventListener(exports.SocketState.SOCKET_CONNECT)},r.onReady=function(e){this.emitter.emit(exports.SocketConnection.READY,e),this.emitter.emit(exports.SocketState.SOCKET_READY,e)},r.onError=function(e){this.emitter.emit(exports.SocketConnection.ERROR,e),this.emitter.emit(exports.SocketState.SOCKET_ERROR,e),this.removeAllSocketListeners(),this.removeEventListener("*")},r.onClose=function(e){void 0===e&&(e=null),this.emitter.emit(exports.SocketConnection.CLOSE,e),this.emitter.emit(exports.SocketState.SOCKET_CLOSE,e),this.removeAllSocketListeners(),this.removeEventListener("*")},t}(R),E={requestHandler:function(e,t){return o(e.url,{method:e.options&&e.options.method?e.options.method:"POST",cache:"no-cache",mode:"cors",redirect:"follow",referrer:"no-referrer",body:JSON.stringify(e.payload),headers:d({},t,e.options&&e.options.headers?e.options.headers:{})})},responseHandler:function(e,t,r){return e.json().then((function(e){return d({},e,{req:t})})).then(r)}},_={"Content-Type":"application/json"};function k(e,t){var r,n=new Promise((function(e,n){r=function(){return n(new Error("request Timeout in "+t+" ms"))}})),i=Promise.race([e,n]);return setTimeout((function(){r()}),t),i}var S=function(){var e=u(s.mark((function e(t,r,n){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,k(n.requestHandler(t,_),t.options&&t.options.timeout?t.options.timeout:12e4);case 3:return e.abrupt("return",n.responseHandler(e.sent,t,r));case 7:throw e.prev=7,e.t0=e.catch(0),e.t0;case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,r,n){return e.apply(this,arguments)}}();function g(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce((function(e,t){return function(r){return e(t(r))}}))}var x,C={method:"POST",timeout:12e4,headers:_,user:null,password:null},P=function(e){function t(t,r,n){var i;return(i=e.call(this,t)||this).url=t||"http://localhost:9500",i.fetcher=n||E,i.options=r?{method:r.method||C.method,timeout:r.timeout||C.timeout,user:r.user||C.user,password:r.password||C.password,headers:r.headers||C.headers}:C,i}l(t,e);var r=t.prototype;return r.send=function(e,t){return this.requestFunc({payload:e,callback:t})},r.sendServer=function(e,t,r){return this.requestFunc({endpoint:e,payload:t,callback:r})},r.requestFunc=function(e){var t=this,r=e.endpoint,n=e.payload,i=e.callback,o=this.getMiddleware(n.method),s=o[1],a=g.apply(void 0,o[0].concat([function(e){return t.optionsHandler(e)},function(e){return t.endpointHandler(e,r)},this.payloadHandler])),c=g.apply(void 0,[function(e){return t.callbackHandler(e,i)}].concat(s)),u=a(n);return S(u,c,this.fetcher)},r.payloadHandler=function(e){return{payload:e}},r.endpointHandler=function(e,t){return d({},e,{url:null!=t?""+this.url+t:this.url})},r.optionsHandler=function(e){if(this.options.user&&this.options.password){var t="Basic "+Buffer.from(this.options.user+":"+this.options.password).toString("base64");this.options.headers.Authorization=t}return d({},e,{options:this.options})},r.callbackHandler=function(e,t){return t&&t(null,e),e},r.subscribe=function(){throw new Error("HTTPProvider does not support subscriptions.")},r.unsubscribe=function(){throw new Error("HTTPProvider does not support subscriptions.")},t}(R),T=function(){var e=this;this.toPayload=function(t,r){if(!t)throw new Error("jsonrpc method should be specified!");e.messageId+=1;var n=void 0===r?[]:"string"==typeof r?[r]:[].concat(r);return{jsonrpc:"2.0",id:e.messageId,method:t,params:n}},this.messageId=0},O=function(e){function t(t,r){var n;if(void 0===r&&(r={}),n=e.call(this,t)||this,!i.isWs(t))throw new Error(t+" is not websocket");return n.url=t,n.options=r,n.connection=n.createWebsocketProvider(n.url,n.options),n.jsonRpc=new T,n.subscriptions={},n.registerEventListeners(),n}l(t,e);var r=t.prototype;return r.on=function(e,t){return this.emitter.on(e,t),this},r.onData=function(e){return this.emitter.on("data",e),this},r.onError=function(t){"ECONNREFUSED"!==t.code?e.prototype.onError.call(this,t):this.reconnect()},r.onClose=function(t){1e3===t.code&&!1!==t.wasClean?e.prototype.onClose.call(this):this.reconnect()},r.createWebsocketProvider=function(e,t){if(void 0===t&&(t={}),"undefined"!=typeof window&&window.WebSocket)return new WebSocket(e,t.protocol);var r=t.headers||{},n=new URL(e);if(!r.authorization&&n.username&&n.password){var i=Buffer.from(n.username+":"+n.password).toString("base64");r.authorization="Basic "+i}return new a.w3cwebsocket(e,t.protocol,void 0,r,void 0,t.clientConfig)},r.reconnect=function(){var e=this;setTimeout((function(){e.removeAllSocketListeners(),e.connection=e.createWebsocketProvider(e.url,e.options),e.registerEventListeners()}),5e3)},r.isConnecting=function(){return this.connection.readyState===this.connection.CONNECTING},r.send=function(e){var t=this,r=this.getMiddleware(e.method),n=r[1],i=g.apply(void 0,r[0]),o=g.apply(void 0,n);return new Promise((function(r,n){if(t.connected)try{t.connection.send(i(JSON.stringify(e)))}catch(e){throw t.removeEventListener(exports.SocketConnection.ERROR),e}t.emitter.on(exports.SocketConnection.CONNECT,(function(){try{t.connection.send(i(JSON.stringify(e)))}catch(e){throw t.removeEventListener(exports.SocketConnection.ERROR),e}})),t.emitter.on(""+e.id,(function(n){r(o(n)),t.removeEventListener(""+e.id)})),t.emitter.on(exports.SocketConnection.ERROR,n)}))},r.subscribe=function(){var e=u(s.mark((function e(t){var r,n;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.send(t);case 2:if(!((n=this.validate(r=e.sent))instanceof Error)){e.next=6;break}throw n;case 6:return this.subscriptions[r.result]={id:r.result,subscribeMethod:t.method,parameters:t.params,payload:t},e.abrupt("return",r.result);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.unsubscribe=function(){var e=u(s.mark((function e(t){var r,n=this;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.hasSubscription(r=t.params[0])){e.next=3;break}return e.abrupt("return",this.send(t).then((function(e){return e&&(n.removeEventListener(n.getSubscriptionEvent(r)),delete n.subscriptions[r]),e})));case 3:return e.abrupt("return",Promise.reject(new Error("Provider error: Subscription with ID "+r+" does not exist.")));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.clearSubscriptions=function(){var e=u(s.mark((function e(t){var r,n,i=this;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[],Object.keys(this.subscriptions).forEach((function(e){i.removeEventListener(e),r.push(i.unsubscribe(i.jsonRpc.toPayload(t,i.subscriptions[e].id)))})),e.next=4,Promise.all(r);case 4:if(!(n=e.sent).includes(!1)){e.next=7;break}throw new Error("Could not unsubscribe all subscriptions: "+JSON.stringify(n));case 7:return e.abrupt("return",!0);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.registerEventListeners=function(){this.connection.onmessage=this.onMessage.bind(this),this.connection.onopen=this.onReady.bind(this),this.connection.onopen=this.onConnect.bind(this),this.connection.onclose=this.onClose.bind(this),this.connection.onerror=this.onError.bind(this)},r.onMessage=function(e){if(!e||!e.data)throw new Error("provider error");var t,r;try{t=i.isObject(e.data)?e.data:JSON.parse(e.data),i.isArray(t)&&(r=t[0].id),r=void 0===t.id?this.getSubscriptionEvent(t.params.subscription)||t.params.subscription:t.id}catch(e){throw e}this.emitter.emit(exports.SocketState.SOCKET_MESSAGE,t),this.emitter.emit(""+r,t)},r.onConnect=function(){var e=u(s.mark((function e(){var t,r,n,i,o;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.subscriptions||(this.subscriptions={}),!((t=Object.keys(this.subscriptions)).length>0)){e.next=13;break}r=v(t);case 4:if((n=r()).done){e.next=13;break}return i=n.value,e.next=8,this.subscribe(this.subscriptions[i].payload);case 8:delete this.subscriptions[o=e.sent],this.subscriptions[i].id=o;case 11:e.next=4;break;case 13:this.emitter.emit(exports.SocketState.SOCKET_CONNECT),this.emitter.emit(exports.SocketConnection.CONNECT);case 15:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r.getSubscriptionEvent=function(e){var t,r=this;return this.subscriptions[e]?e:(Object.keys(this.subscriptions).forEach((function(n){r.subscriptions[n].id===e&&(t=n)})),t)},r.hasSubscription=function(e){return void 0!==this.getSubscriptionEvent(e)},r.validate=function(e,t){return i.isObject(e)?e.error?e.error instanceof Error?new Error("Node error: "+e.error.message):new Error("Node error: "+JSON.stringify(e.error)):t&&e.id!==t.id?new Error("Validation error: Invalid JSON-RPC response ID (request: "+t.id+" / response: "+e.id+")"):void 0!==e.result||new Error("Validation error: Undefined JSON-RPC result"):new Error("Validation error: Response should be of type Object")},p(t,[{key:"connected",get:function(){return this.connection.readyState===this.connection.OPEN}}]),t}(w),L=function(){function e(){var e=this;this.handlers={},this.emitter=n(this.handlers),this.off=this.emitter.off.bind(this),this.emit=this.emitter.emit.bind(this),this.promise=new Promise((function(t,r){e.resolve=t,e.reject=r})),this.then=this.promise.then.bind(this.promise)}var t=e.prototype;return t.resetHandlers=function(){for(var e in this.handlers)delete this.handlers[e]},t.on=function(e,t){return this.emitter.on(e,t),this},t.once=function(e,t){var r=this;this.emitter.on(e,(function(n){t(n),r.removeEventListener(e)}))},t.addEventListener=function(e,t){this.emitter.on(e,t)},t.removeEventListener=function(e,t){if(e)return t?this.emitter.off(e,t):void delete this.handlers[e];this.handlers={}},t.onError=function(e){this.emitter.on("error",e),this.removeEventListener("*")},t.onData=function(e){this.emitter.on("data",e),this.removeEventListener("*")},t.listenerCount=function(e){var t=0;return Object.keys(this.handlers).forEach((function(r){e===r&&(t+=1)})),t},e}();(x=exports.ProviderType||(exports.ProviderType={})).http="http",x.ws="ws";var I,B,N=function(){function e(e){this.provider=this.onInitSetProvider(e),this.providerType=this.getType(this.provider)}e.getProvider=function(t){try{return this.getProvider(t),new e(t)}catch(e){throw e}};var t=e.prototype;return t.onInitSetProvider=function(e){if("string"==typeof e)return i.isHttp(e)?new P(e):i.isWs(e)?new O(e):new P(i.defaultConfig.Default.Chain_URL);try{var t=this.getType(e);if(t===exports.ProviderType.http||t===exports.ProviderType.ws)return e;throw new Error("cannot get provider type")}catch(e){throw e}},t.getType=function(e){if(e instanceof P)return exports.ProviderType.http;if(e instanceof O)return exports.ProviderType.ws;throw new Error("provider is not correct")},e}(),A=function(){function e(e){this.result=e.result,this.error=e.error,this.raw=e,this.responseType=this.getResponseType()}var t=e.prototype;return t.getResponseType=function(){return this.error?"error":this.result||null===this.result&&void 0!==this.result?"result":"raw"},t.isError=function(){return"error"===this.responseType},t.isResult=function(){return"result"===this.responseType},t.isRaw=function(){return"raw"===this.responseType},p(e,[{key:"getResult",get:function(){return i.isObject(this.result)?d({},this.result,{responseType:"result"}):this.result}},{key:"getError",get:function(){return i.isObject(this.error)?d({},this.error,{responseType:"error"}):this.error}},{key:"getRaw",get:function(){return d({},this.raw,{responseType:"raw"})}}]),e}();(I=exports.RPCMethod||(exports.RPCMethod={})).GetBlockByHash="hmy_getBlockByHash",I.GetBlockByNumber="hmy_getBlockByNumber",I.GetBlockTransactionCountByHash="hmy_getBlockTransactionCountByHash",I.GetBlockTransactionCountByNumber="hmy_getBlockTransactionCountByNumber",I.GetCode="hmy_getCode",I.GetTransactionByBlockHashAndIndex="hmy_getTransactionByBlockHashAndIndex",I.GetTransactionByBlockNumberAndIndex="hmy_getTransactionByBlockNumberAndIndex",I.GetTransactionByHash="hmy_getTransactionByHash",I.GetTransactionReceipt="hmy_getTransactionReceipt",I.GetCXReceiptByHash="hmy_getCXReceiptByHash",I.Syncing="hmy_syncing",I.PeerCount="net_peerCount",I.GetBalance="hmy_getBalance",I.GetStorageAt="hmy_getStorageAt",I.GetTransactionCount="hmy_getTransactionCount",I.SendTransaction="hmy_sendTransaction",I.SendRawTransaction="hmy_sendRawTransaction",I.Subscribe="hmy_subscribe",I.GetPastLogs="hmy_getLogs",I.GetWork="hmy_getWork",I.GetProof="hmy_getProof",I.GetFilterChanges="hmy_getFilterChanges",I.NewPendingTransactionFilter="hmy_newPendingTransactionFilter",I.NewBlockFilter="hmy_newBlockFilter",I.NewFilter="hmy_newFilter",I.Call="hmy_call",I.EstimateGas="hmy_estimateGas",I.GasPrice="hmy_gasPrice",I.BlockNumber="hmy_blockNumber",I.UnSubscribe="hmy_unsubscribe",I.NetVersion="net_version",I.ProtocolVersion="hmy_protocolVersion",I.GetShardingStructure="hmy_getShardingStructure",I.SendRawStakingTransaction="hmy_sendRawStakingTransaction",I.GetAccountNonce="hmy_getAccountNonce",(B=exports.RPCErrorCode||(exports.RPCErrorCode={}))[B.RPC_INVALID_REQUEST=-32600]="RPC_INVALID_REQUEST",B[B.RPC_METHOD_NOT_FOUND=-32601]="RPC_METHOD_NOT_FOUND",B[B.RPC_INVALID_PARAMS=-32602]="RPC_INVALID_PARAMS",B[B.RPC_INTERNAL_ERROR=-32603]="RPC_INTERNAL_ERROR",B[B.RPC_PARSE_ERROR=-32700]="RPC_PARSE_ERROR",B[B.RPC_MISC_ERROR=-1]="RPC_MISC_ERROR",B[B.RPC_TYPE_ERROR=-3]="RPC_TYPE_ERROR",B[B.RPC_INVALID_ADDRESS_OR_KEY=-5]="RPC_INVALID_ADDRESS_OR_KEY",B[B.RPC_INVALID_PARAMETER=-8]="RPC_INVALID_PARAMETER",B[B.RPC_DATABASE_ERROR=-20]="RPC_DATABASE_ERROR",B[B.RPC_DESERIALIZATION_ERROR=-22]="RPC_DESERIALIZATION_ERROR",B[B.RPC_VERIFY_ERROR=-25]="RPC_VERIFY_ERROR",B[B.RPC_VERIFY_REJECTED=-26]="RPC_VERIFY_REJECTED",B[B.RPC_IN_WARMUP=-28]="RPC_IN_WARMUP",B[B.RPC_METHOD_DEPRECATED=-32]="RPC_METHOD_DEPRECATED";var D=function(e){function t(t,r,n,o){var a;return void 0===r&&(r=i.defaultConfig.Default.Chain_Type),void 0===n&&(n=i.defaultConfig.Default.Chain_ID),void 0===o&&(o=i.defaultConfig),(a=e.call(this,r,n)||this).Network_ID="Default",a.send=function(){var e=u(s.mark((function e(t,r,n,o){var c,u,h;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===o&&(o=a.currentShard),a.providerCheck(),c=t,n&&i.isString(n)&&n!==a.chainPrefix?c=a.setRPCPrefix(t,n):n&&n!==a.chainPrefix||(c=a.setRPCPrefix(t,a.chainPrefix)),e.prev=4,u=a.JsonRpc.toPayload(c,r),h=a.getShardProvider(o),a.setResMiddleware((function(e){return e instanceof A?e:new A(e)}),"*",h),e.next=10,h.send(u);case 10:return e.abrupt("return",e.sent);case 14:throw e.prev=14,e.t0=e.catch(4),new Error(e.t0);case 17:case"end":return e.stop()}}),e,null,[[4,14]])})));return function(t,r,n,i){return e.apply(this,arguments)}}(),a.subscribe=function(){var e=u(s.mark((function e(t,r,n,o,c){var u,h,p,d,l;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n=exports.SubscribeReturns.all),void 0===o&&(o=a.chainPrefix),void 0===c&&(c=a.currentShard),u=t,o&&i.isString(o)&&o!==a.chainPrefix?u=a.setRPCPrefix(t,o):o&&o!==a.chainPrefix||(u=a.setRPCPrefix(t,a.chainPrefix)),h=null,!((p=a.getShardProvider(c))instanceof O)){e.next=37;break}return d=p,e.prev=9,l=a.JsonRpc.toPayload(u,r),e.next=13,d.subscribe(l);case 13:d.on(h=e.sent,(function(e){d.emitter.emit("data",e)})),d.once("error",(function(e){d.removeEventListener(h),d.emitter.emit("error",e),d.removeEventListener("*")})),e.next=22;break;case 18:e.prev=18,e.t0=e.catch(9),d.emitter.emit("error",e.t0),d.removeEventListener("*");case 22:if(n!==exports.SubscribeReturns.all){e.next=26;break}return e.abrupt("return",[d,h]);case 26:if(n!==exports.SubscribeReturns.method){e.next=30;break}return e.abrupt("return",d);case 30:if(n!==exports.SubscribeReturns.id){e.next=34;break}return e.abrupt("return",h);case 34:throw new Error("Invalid returns");case 35:e.next=38;break;case 37:throw new Error("HttpProvider does not support this");case 38:case"end":return e.stop()}}),e,null,[[9,18]])})));return function(t,r,n,i,o){return e.apply(this,arguments)}}(),a.unsubscribe=function(){var e=u(s.mark((function e(t,r,n,o){var c,u,h;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===o&&(o=a.currentShard),c=t,n&&i.isString(n)&&n!==a.chainPrefix?c=a.setRPCPrefix(t,n):n&&n!==a.chainPrefix||(c=a.setRPCPrefix(t,a.chainPrefix)),!(a.getShardProvider(o)instanceof O)){e.next=19;break}return u=a.provider,e.prev=6,h=a.JsonRpc.toPayload(c,r),e.next=10,u.unsubscribe(h);case 10:return e.abrupt("return",e.sent);case 14:throw e.prev=14,e.t0=e.catch(6),e.t0;case 17:e.next=20;break;case 19:throw new Error("HttpProvider does not support this");case 20:case"end":return e.stop()}}),e,null,[[6,14]])})));return function(t,r,n,i){return e.apply(this,arguments)}}(),a.provider=t,a.config=o,a.JsonRpc=new T,a.setNetworkID(i.defaultConfig.Default.Network_ID),a.shardProviders=new Map,a}l(t,e);var r=t.prototype;return r.setProvider=function(e){this.provider=e},r.providerCheck=function(){if(!this.provider)throw new Error("provider is not found")},r.setReqMiddleware=function(e,t,r){void 0===t&&(t="*"),r.middlewares.request.use(e,t)},r.setResMiddleware=function(e,t,r){void 0===t&&(t="*"),r.middlewares.response.use(e,t)},r.setNetworkID=function(e){this.Network_ID=e},r.setRPCPrefix=function(e,t){var r=e.split("_");if(2!==r.length)throw new Error("could not set prefix with "+e);return r[0]=t,r.join("_")},r.setShardingProviders=function(){var e=u(s.mark((function e(){var t,r,n,o,a;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.chainPrefix===i.ChainType.Avalanche){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.send(exports.RPCMethod.GetShardingStructure,[],this.chainPrefix);case 5:if((t=e.sent).result)for(r=v(t.result);!(n=r()).done;)a="string"==typeof(o=n.value).shardID?Number.parseInt(o.shardID,10):o.shardID,this.shardProviders.set(a,{current:o.current,shardID:a,http:o.http,ws:o.ws});e.next=12;break;case 9:return e.prev=9,e.t0=e.catch(2),e.abrupt("return");case 12:case"end":return e.stop()}}),e,this,[[2,9]])})));return function(){return e.apply(this,arguments)}}(),r.getShardProvider=function(e){var t=this.shardProviders.get(e);return t?this.provider instanceof P?new P(t.http):new O(t.ws):this.provider},r.getCurrentShardID=function(){for(var e,t=v(this.shardProviders);!(e=t()).done;){var r=e.value;if(!0===r[1].current||r[1].http===this.provider.url||r[1].ws===this.provider.url)return r[1].shardID}},r.setDefaultShardID=function(e){this.defaultShardID=e},p(t,[{key:"currentShard",get:function(){return this.getCurrentShardID()||this.defaultShardID||0}},{key:"shardCount",get:function(){return this.shardProviders.size}}]),t}(i.AvalancheCore),M=function(e,t){return e+t},H=["sync","latest"],j=function(e){function t(t){var r;return void 0===t&&(t={blockResetDuration:void 0,retryTimeout:void 0,keepEventLoopActive:void 0,setSkipCacheFlag:!1}),(r=e.call(this)||this)._blockResetDuration=t.blockResetDuration||2e4,r._currentBlock=null,r._isRunning=!1,r._maybeStart(),r}l(t,e);var r=t.prototype;return r.isRunning=function(){return this._isRunning},r.getCurrentBlock=function(){return this._currentBlock},r.getLatestBlock=function(){var e=u(s.mark((function e(){var t=this;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._currentBlock){e.next=2;break}return e.abrupt("return",this._currentBlock);case 2:return e.next=4,new Promise((function(e){return t.once("latest",e)}));case 4:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r.removeAllListeners=function(t){e.prototype.removeEventListener.call(this,t||"*"),this._setupInternalEvents(),this._onRemoveListener("*")},r._start=function(){},r._end=function(){},r._setupInternalEvents=function(){this.removeEventListener("newListener",this._onNewListener),this.removeEventListener("removeListener",this._onRemoveListener),this.on("newListener",this._onNewListener),this.on("removeListener",this._onRemoveListener)},r._onNewListener=function(e,t){H.includes(e)&&this._maybeStart()},r._onRemoveListener=function(e,t){this._getBlockTrackerEventCount()>0||this._maybeEnd()},r._maybeStart=function(){this._isRunning||(this._isRunning=!0,this._cancelBlockResetTimeout(),this._start())},r._maybeEnd=function(){this._isRunning&&(this._isRunning=!1,this._setupBlockResetTimeout(),this._end())},r._getBlockTrackerEventCount=function(){var e=this;return H.map((function(t){return e.listenerCount(t)})).reduce(M)},r._newPotentialLatest=function(e){var t=this._currentBlock;t&&i.isHex(t)&&i.isHex(e)&&i.hexToNumber(e)<=i.hexToNumber(t)||this._setCurrentBlock(e)},r._setCurrentBlock=function(e){var t=this._currentBlock;this._currentBlock=e,this.emit("latest",e),this.emit("sync",{oldBlock:t,newBlock:e})},r._setupBlockResetTimeout=function(){this._cancelBlockResetTimeout(),this._blockResetTimeout=setTimeout(this._resetCurrentBlock,this._blockResetDuration),this._blockResetTimeout.unref&&this._blockResetTimeout.unref()},r._cancelBlockResetTimeout=function(){clearTimeout(this._blockResetTimeout)},r._resetCurrentBlock=function(){this._currentBlock=null},t}(L);function G(e,t){return new Promise((function(r){var n=setTimeout(r,e);n.unref&&t&&n.unref()}))}var F=function(e){function t(t,r){var n;if(void 0===r&&(r={pollingInterval:void 0,retryTimeout:void 0,keepEventLoopActive:!1,setSkipCacheFlag:!1}),!t)throw new Error("PollingBlockTracker - no provider specified.");var i=r.pollingInterval||2e4,o=r.retryTimeout||i/10,s=void 0===r.keepEventLoopActive||r.keepEventLoopActive,a=r.setSkipCacheFlag||!1;return(n=e.call(this,{blockResetDuration:i,retryTimeout:o,keepEventLoopActive:s,setSkipCacheFlag:a})||this).messenger=t,n._pollingInterval=i,n._retryTimeout=o,n._keepEventLoopActive=s,n._setSkipCacheFlag=a,n}l(t,e);var r=t.prototype;return r.checkForLatestBlock=function(){var e=u(s.mark((function e(){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._updateLatestBlock();case 2:return e.next=4,this.getLatestBlock();case 4:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r._start=function(){var e=this;this._performSync().catch((function(t){return e.emit("error",t)}))},r._performSync=function(){var e=u(s.mark((function e(){var t;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._isRunning){e.next=16;break}return e.prev=1,e.next=4,this._updateLatestBlock();case 4:return e.next=6,G(this._pollingInterval,!this._keepEventLoopActive);case 6:e.next=14;break;case 8:e.prev=8,e.t0=e.catch(1),t=new Error("PollingBlockTracker - encountered an error while attempting to update latest block:\n"+e.t0.stack);try{this.emit("error",t)}catch(e){console.error(t)}return e.next=14,G(this._retryTimeout,!this._keepEventLoopActive);case 14:e.next=0;break;case 16:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(){return e.apply(this,arguments)}}(),r._updateLatestBlock=function(){var e=u(s.mark((function e(){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._fetchLatestBlock();case 2:this._newPotentialLatest(e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r._fetchLatestBlock=function(){var e=u(s.mark((function e(){var t;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.messenger.send(exports.RPCMethod.BlockNumber,[]);case 3:if(!(t=e.sent).isError()){e.next=8;break}throw t.message;case 8:if(!t.isResult()){e.next=10;break}return e.abrupt("return",t.result);case 10:e.next=15;break;case 12:throw e.prev=12,e.t0=e.catch(0),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),t}(j),q=function(e){function t(t,r){var n;if(void 0===r&&(r={}),!t)throw new Error("SubscribeBlockTracker - no provider specified.");if(!(t.provider instanceof O))throw new Error("This provider not supported");return(n=e.call(this,r)||this).messenger=t,n.subscriptionId=null,n}l(t,e);var r=t.prototype;return r.checkForLatestBlock=function(){var e=u(s.mark((function e(){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getLatestBlock();case 2:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r._start=function(){var e=u(s.mark((function e(){var t,r;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.messenger.send(exports.RPCMethod.BlockNumber,[]);case 3:if(!(t=e.sent).isError()){e.next=8;break}throw t.message;case 8:if(!t.isResult()){e.next=15;break}return e.next=11,this.messenger.subscribe(exports.RPCMethod.Subscribe,["newHeads"]);case 11:this.subscriptionId=r=e.sent,r[0].onData(this._handleSubData),this._newPotentialLatest(t);case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(0),this.emit("error",e.t0);case 20:case"end":return e.stop()}}),e,this,[[0,17]])})));return function(){return e.apply(this,arguments)}}(),r._end=function(){var e=u(s.mark((function e(){return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null!=this.subscriptionId&&(this.messenger.unsubscribe(exports.RPCMethod.UnSubscribe,[this.subscriptionId]),delete this.subscriptionId);case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r._handleSubData=function(e){e.params.subscription===this.subscriptionId&&this._newPotentialLatest(e.params.result.number)},t}(j),K=function(e){function t(t,r,n,i){var o;return void 0===i&&(i=0),(o=e.call(this,0!==i?n.getShardProvider(i).url:n.provider.url)||this).subscriptionId=null,o.shardID=i,o.param=t,o.options=r,o.messenger=n,o}l(t,e);var r=t.prototype;return r.constructPayload=function(e,t,r){var n,i=[];return i.push(t),r&&i.push(r),n=this.messenger.setRPCPrefix(e,this.messenger.chainPrefix),this.jsonRpc.toPayload(n,i)},r.start=function(){var t=u(s.mark((function t(){var r,n,i=this;return s.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=this.constructPayload(exports.RPCMethod.Subscribe,this.param,this.options),t.prev=1,t.next=4,e.prototype.subscribe.call(this,r);case 4:this.subscriptionId=n=t.sent,this.on(n,(function(e){var t=i.onNewSubscriptionItem(e);i.emitter.emit("data",t)})),this.once("error",(function(e){i.removeEventListener(n),i.emitter.emit("error",e),i.removeEventListener("*")})),t.next=14;break;case 10:t.prev=10,t.t0=t.catch(1),this.emitter.emit("error",t.t0),this.removeEventListener("*");case 14:return t.abrupt("return",this);case 15:case"end":return t.stop()}}),t,this,[[1,10]])})));return function(){return t.apply(this,arguments)}}(),r.unsubscribe=function(){var t=this.constructPayload(exports.RPCMethod.UnSubscribe,this.subscriptionId);return e.prototype.unsubscribe.call(this,t)},r.onNewSubscriptionItem=function(e){return e},t}(O),U=function(e){function t(t,r,n){var i;return void 0===n&&(n=0),(i=e.call(this,"logs",t,r,n)||this).preprocess(),i}l(t,e);var r=t.prototype;return r.preprocess=function(){var e=u(s.mark((function e(){var t,r=this;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.options.fromBlock&&"latest"!==this.options.fromBlock||0===this.options.fromBlock||"0x"===this.options.fromBlock)){e.next=14;break}return e.prev=1,e.next=4,this.messenger.send(exports.RPCMethod.GetPastLogs,[].concat(this.options),this.messenger.chainType,this.shardID);case 4:return(t=e.sent).isError()?this.emitter.emit("error",t.error.message):t.result.forEach((function(e){var t=r.onNewSubscriptionItem(e);r.emitter.emit("data",t)})),delete this.options.fromBlock,e.abrupt("return",this.start());case 10:throw e.prev=10,e.t0=e.catch(1),this.emitter.emit("error",e.t0),e.t0;case 14:return e.abrupt("return",this.start());case 15:case"end":return e.stop()}}),e,this,[[1,10]])})));return function(){return e.apply(this,arguments)}}(),r.onNewSubscriptionItem=function(e){var t=e;return t.removed&&this.emitter.emit("changed",t),t},t}(K),V=function(e){function t(t,r){var n;return void 0===r&&(r=0),(n=e.call(this,"newHeads",void 0,t,r)||this).start(),n}return l(t,e),t}(K),J=function(e){function t(t,r){var n;return void 0===r&&(r=0),(n=e.call(this,"newPendingTransactions",void 0,t,r)||this).start(),n}return l(t,e),t}(K),W=function(e){function t(t,r){var n;return void 0===r&&(r=0),(n=e.call(this,"syncing",void 0,t,r)||this).isSyncing=null,n.start(),n}return l(t,e),t.prototype.onNewSubscriptionItem=function(e){var t=e.params.result.syncing;return null===this.isSyncing&&(this.isSyncing=t,this.emitter.emit("changed",this.isSyncing)),!0===this.isSyncing&&!1===t&&(this.isSyncing=t,this.emitter.emit("changed",this.isSyncing)),!1===this.isSyncing&&!0===t&&(this.isSyncing=t,this.emitter.emit("changed",this.isSyncing)),e},t}(K);exports.mitt=n,exports.BaseBlockTracker=j,exports.BaseProvider=R,exports.BaseSocket=w,exports.DEFAULT_HEADERS=_,exports.DEFAULT_TIMEOUT=12e4,exports.Emitter=L,exports.HttpProvider=P,exports.JsonRpc=T,exports.LogSub=U,exports.Messenger=D,exports.NewHeaders=V,exports.NewPendingTransactions=J,exports.PollingBlockTracker=F,exports.Provider=N,exports.ResponseMiddleware=A,exports.SubscribeBlockTracker=q,exports.SubscriptionMethod=K,exports.Syncing=W,exports.WSProvider=O,exports.composeMiddleware=g,exports.fetchRPC=E,exports.getRawForData=function(e){return e.getRaw},exports.getResultForData=function(e){return e.result?e.getResult:e.error?e.getError:e.getRaw},exports.onResponse=function(e){return"result"===e.responseType?e.getResult:"error"===e.responseType?e.getError:e.raw},exports.performRPC=S,exports.timeout=G;
//# sourceMappingURL=avalanche-js-network.cjs.production.min.js.map
